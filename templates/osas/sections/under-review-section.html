<div class="section-header">
    <div class="header-content">
        <div class="title-section">
            <h2 class="section-heading">Active Complaints</h2>
            <div class="divider"></div>
        </div>

        <div class="complaint-stats-section">
            <div class="complaint-stats-container">
                <!-- Total Complaints -->
                <div class="complaint-stat-box total">
                    <div class="stat-icon" style="background-color: #4caf50;">
                        <i class='bx bx-file'></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ total_complaints }}</div>
                        <div class="stat-label">Total Complaints</div>
                    </div>
                </div>

                <!-- Under Review -->
                <div class="complaint-stat-box under-review">
                    <div class="stat-icon" style="background-color: #2196f3;">
                        <i class='bx bx-time'></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ pure_under_review_count }}</div>
                        <div class="stat-label">Under Review</div>
                    </div>
                </div>

                <!-- 1st Hearing -->
                <div class="complaint-stat-box first-hearing">
                    <div class="stat-icon" style="background-color: #ff9800;">
                        <i class='bx bx-calendar-alt'></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ first_hearing_count }}</div>
                        <div class="stat-label">1st Hearing</div>
                    </div>
                </div>

                <!-- 2nd Hearing -->
                <div class="complaint-stat-box second-hearing">
                    <div class="stat-icon" style="background-color: #9c27b0;">
                        <i class='bx bx-calendar'></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ second_hearing_count }}</div>
                        <div class="stat-label">2nd Hearing</div>
                    </div>
                </div>

                <!-- Other Hearing -->
                <div class="complaint-stat-box other-hearing">
                    <div class="stat-icon" style="background-color: #673ab7;">
                        <i class='bx bx-calendar-event'></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ other_hearing_count }}</div>
                        <div class="stat-label">Other Hearing</div>
                    </div>
                </div>

                <!-- Ongoing Hearing -->
                <div class="complaint-stat-box ongoing-hearing">
                    <div class="stat-icon" style="background-color: #ff5722;">
                        <i class='bx bx-microphone'></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ ongoing_hearing_count }}</div>
                        <div class="stat-label">Ongoing Hearing</div>
                    </div>
                </div>

                <!-- Canceled -->
                <div class="complaint-stat-box canceled">
                    <div class="stat-icon" style="background-color: #f44336;">
                        <i class='bx bx-x-circle'></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ canceled_count }}</div>
                        <div class="stat-label">Canceled</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="search-box">
                <i class='bx bx-search'></i>
                <input type="text" id="under-review-search" placeholder="Search complaints..." class="search-input">
            </div>
            <div class="filter-group">
                <select id="statusFilter" class="styled-select">
                    <option value="all">All Statuses</option>
                    <option value="under_review">Under Review</option>
                    <option value="1st_hearing">1st Hearing</option>
                    <option value="2nd_hearing">2nd Hearing</option>
                    <option value="other_hearing">Other Hearing</option>
                    <option value="ongoing_hearing">Ongoing Hearing</option>
                    <option value="canceled">Canceled</option>
                </select>
            </div>
            <div class="filter-group">
                <select id="underReviewDateFilter" class="styled-select">
                    <option value="all">Sort by Dates</option>
                    <option value="incident_oldest">Oldest Incident</option>
                    <option value="incident_newest">Newest Incident</option>
                    <option value="incident_day">Incident This Day</option>
                    <option value="incident_week">Incident This Week</option>
                    <option value="incident_month">Incident This Month</option>
                    <option value="this_year">This Year</option>
                    <option value="last_year">Last Year</option>
                </select>
            </div>
            {% if perms.osas.add_complaint %}
            <a href="{% url 'complaint-create' %}" class="primary-btn">
                <i class="fas fa-plus"></i> New Complaint
            </a>
            {% endif %}
            {% if request.user.is_superuser or request.user.user_type == 1 or request.user.user_type == 11 %}
            <button id="export-complaint-btn" class="primary-btn">
                <i class='bx bx-export'></i> Export Data
            </button>
            {% endif %}
        </div>
    </div>
</div>

<div id="under-review-table-container">
    <div id="under-review-loading" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
        </div>
    </div>

    <table class="data-table" id="under-review-table">
        <thead>
            <tr>
                <th data-sort="reference_number">Ref No. <i class='bx bx-sort'></i></th>
                <th data-sort="title">Title <i class='bx bx-sort'></i></th>
                <th data-sort="complainant">Complainant <i class='bx bx-sort'></i></th>
                <th data-sort="incident_date">Incident Date <i class='bx bx-sort'></i></th>
                <th>Status</th>
                <th>Next Hearing</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for complaint in complaints %}
            {% if complaint.status != 'resolved' and not complaint.is_archived %}
            <tr data-id="{{ complaint.id }}"
                data-created="{{ complaint.created_at|date:'Y-m-d' }}"
                data-status="{{ complaint.status }}">
                <td>{{ complaint.reference_number }}</td>
                <td>{{ complaint.title }}</td>
                <td>{{ complaint.complainant_first_name }} {{ complaint.complainant_last_name }}</td>
                <td>{{ complaint.incident_date|date:"M d, Y" }}</td>
                <td>
                    {% if complaint.status == 'under_review' %}
                    <span class="status-badge under-review">
                        Under Review
                    </span>
                    {% elif complaint.status == '1st_hearing' %}
                    <span class="status-badge first-hearing">
                        1st Hearing
                    </span>
                    {% elif complaint.status == '2nd_hearing' %}
                    <span class="status-badge second-hearing">
                        2nd Hearing
                    </span>
                    {% elif complaint.status == 'other_hearing' %}
                    <span class="status-badge other-hearing">
                        Other Hearing
                    </span>
                    {% elif complaint.status == 'ongoing_hearing' %}
                    <span class="status-badge ongoing-hearing">
                        Ongoing Hearing
                    </span>
                    {% elif complaint.status == 'resolved' %}
                    <span class="status-badge resolved">
                        Resolved
                    </span>
                    {% elif complaint.status == 'canceled' %}
                    <span class="status-badge canceled">
                        Canceled
                    </span>
                    {% endif %}
                </td>
                <td>
                    {% if complaint.next_hearing %}
                        {{ complaint.next_hearing.schedule_date|date:"M d, Y" }}
                        {{ complaint.next_hearing.schedule_time|time:"g:i A" }}
                    {% else %}
                        No hearing scheduled
                    {% endif %}
                </td>
                <td class="actions">
                    {% if request.user.is_superuser or request.user.user_type == 1 or request.user.user_type == 11 or complaint.created_by == request.user %}
                        {% if request.user.is_superuser or request.user.user_type == 1 or request.user.user_type == 11 %}
                            {% if complaint.status != 'canceled' %}
                            <button class="btn-action resolve btn-icon"
                                    title="Update Status"
                                    data-id="{{ complaint.id }}"
                                    data-ref="{{ complaint.reference_number }}"
                                    data-title="{{ complaint.title }}">
                                <i class='bx bx-check'></i>
                            </button>
                            {% endif %}
                        {% endif %}
                        {% if perms.osas.view_complaint %}
                        <button class="view-complaint btn-action view btn-icon" data-id="{{ complaint.id }}">
                            <i class='bx bx-show'></i>
                        </button>
                        {% endif %}
                        {% if perms.osas.change_complaint %}
                        <button class="btn-action edit btn-icon edit-under-review" title="Edit" data-id="{{ complaint.id }}">
                            <i class='bx bx-edit'></i>
                        </button>
                        {% endif %}
                        {% if perms.osas.delete_complaint %}
                        <button class="btn-icon archive archive-complaint btn-icon"
                                title="Archive Complaint"
                                data-id="{{ complaint.id }}"
                                data-ref="{{ complaint.reference_number }}"
                                data-title="{{ complaint.title }}">
                            <i class='bx bx-archive'></i>
                        </button>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination controls -->
    {% if complaints %}
    <div class="pagination-container">
        <div class="pagination-info">
            Showing {{ complaints.start_index }} to {{ complaints.end_index }} of {{ complaints.paginator.count }} entries
        </div>
        <div class="pagination-controls">
            {% if complaints.has_previous %}
                <a href="javascript:void(0);" class="pagination-btn first-page" title="First Page" data-page="1">
                    <i class='bx bx-chevrons-left'></i>
                </a>
                <a href="javascript:void(0);" class="pagination-btn prev-page" title="Previous Page" data-page="{{ complaints.previous_page_number }}">
                    <i class='bx bx-chevron-left'></i>
                </a>
            {% else %}
                <span class="pagination-btn first-page disabled" title="First Page">
                    <i class='bx bx-chevrons-left'></i>
                </span>
                <span class="pagination-btn prev-page disabled" title="Previous Page">
                    <i class='bx bx-chevron-left'></i>
                </span>
            {% endif %}

            <div class="page-numbers">
                {% for num in complaints.paginator.page_range %}
                    {% if complaints.number == num %}
                        <span class="pagination-btn current-page active">{{ num }}</span>
                    {% elif num > complaints.number|add:'-3' and num < complaints.number|add:'3' %}
                        <a href="javascript:void(0);" class="pagination-btn page-number" data-page="{{ num }}">{{ num }}</a>
                    {% endif %}
                {% endfor %}
            </div>

            {% if complaints.has_next %}
                <a href="javascript:void(0);" class="pagination-btn next-page" title="Next Page" data-page="{{ complaints.next_page_number }}">
                    <i class='bx bx-chevron-right'></i>
                </a>
                <a href="javascript:void(0);" class="pagination-btn last-page" title="Last Page" data-page="{{ complaints.paginator.num_pages }}">
                    <i class='bx bx-chevrons-right'></i>
                </a>
            {% else %}
                <span class="pagination-btn next-page disabled" title="Next Page">
                    <i class='bx bx-chevron-right'></i>
                </span>
                <span class="pagination-btn last-page disabled" title="Last Page">
                    <i class='bx bx-chevrons-right'></i>
                </span>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>