{% extends 'osas/dashboard.html' %}
{% load static %}

{% block section-content %}
<div class="ojt-edit-container">
    <h2>Edit OJT Page Content</h2>
    {% if form.errors %}
    <div class="alert alert-danger">
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
                <p>{{ field }}: {{ error }}</p>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}
    <form method="post" id="ojtPageForm" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Hero Section -->
        <div class="section-group">
            <h3>Hero Section</h3>
            <div class="form-group">
                <label>Hero Title</label>
                {{ form.hero_title }}
            </div>

            <div class="form-group">
                <label>Hero Subtitle</label>
                {{ form.hero_subtitle }}
            </div>
        </div>

        <!-- Overview Section -->
        <div class="section-group">
            <h3>Overview Section</h3>
            <div class="form-group">
                <label>Overview Title</label>
                {{ form.overview_title }}
            </div>
            <div class="form-group">
                <label>Overview Subtitle</label>
                {{ form.overview_subtitle }}
            </div>

            <div class="form-group">
                <label>Overview Cards</label>
                <div id="overviewCardsContainer">
                    <!-- Overview cards will be added here by JavaScript -->
                </div>
                <button type="button" class="btn btn-sm btn-primary" id="addOverviewCard">Add Overview Card</button>
            </div>
        </div>

        <!-- Services Section -->
        <div class="section-group">
            <h3>Services Section</h3>
            <div class="form-group">
                <label>Services Title</label>
                {{ form.services_title }}
            </div>
            <div class="form-group">
                <label>Services Subtitle</label>
                {{ form.services_subtitle }}
            </div>

            <div class="form-group">
                <label>Services Cards</label>
                <div id="servicesCardsContainer">
                    <!-- Services cards will be added here by JavaScript -->
                </div>
                <button type="button" class="btn btn-sm btn-primary" id="addServicesCard">Add Services Card</button>
            </div>
        </div>

        <!-- Process Section -->
        <div class="section-group">
            <h3>Process Section</h3>
            <div class="form-group">
                <label>Process Title</label>
                {{ form.process_title }}
            </div>
            <div class="form-group">
                <label>Process Subtitle</label>
                {{ form.process_subtitle }}
            </div>

            <div class="form-group">
                <label>Process Steps</label>
                <div id="processStepsContainer">
                    <!-- Process steps will be added here by JavaScript -->
                </div>
                <button type="button" class="btn btn-sm btn-primary" id="addProcessStep">Add Process Step</button>
            </div>
        </div>

        <!-- FAQ Section -->
        <div class="section-group">
            <h3>FAQ Section</h3>
            <div class="form-group">
                <label>FAQ Title</label>
                {{ form.faq_title }}
            </div>
            <div class="form-group">
                <label>FAQ Subtitle</label>
                {{ form.faq_subtitle }}
            </div>

            <div class="form-group">
                <label>FAQ Content</label>
                <div id="faqContainer">
                    <!-- FAQ items will be added here by JavaScript -->
                </div>
                <button type="button" class="btn btn-sm btn-primary" id="addFaq">Add FAQ Item</button>
            </div>
        </div>

        <!-- CTA Section -->
        <div class="section-group">
            <h3>CTA Section</h3>
            <div class="form-group">
                <label>CTA Title</label>
                {{ form.cta_title }}
            </div>
            <div class="form-group">
                <label>CTA Subtitle</label>
                {{ form.cta_subtitle }}
            </div>
            <div class="form-group">
                <label>CTA Button Text</label>
                {{ form.cta_button_text }}
            </div>
        </div>

        <!-- Partners Section -->
        <div class="section-group">
            <h3>Partners Section</h3>
            <div class="form-group">
                <label>Partners Title</label>
                {{ form.partners_title }}
            </div>
            <div class="form-group">
                <label>Partners Subtitle</label>
                {{ form.partners_subtitle }}
            </div>
        </div>

        <!-- Hidden fields -->
        {{ form.overview_cards }}
        {{ form.services_cards }}
        {{ form.process_steps }}
        {{ form.faq_content }}

        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<style>
.section-group {
    background: #f8f9fa;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.section-group h3 {
    color: #007bff;
    margin-bottom: 15px;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 10px;
}

.card-item, .step-item, .faq-item {
    background: white;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

.remove-btn {
    margin-top: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize data
    const overviewCards = JSON.parse('{{ overview_cards_json|escapejs }}') || [];
    const servicesCards = JSON.parse('{{ services_cards_json|escapejs }}') || [];
    const processSteps = JSON.parse('{{ process_steps_json|escapejs }}') || [];
    const faqContent = JSON.parse('{{ faq_content_json|escapejs }}') || [];

    // Overview Cards Management
    const overviewContainer = document.getElementById('overviewCardsContainer');
    const overviewInput = document.getElementById('id_overview_cards');

    function renderOverviewCards() {
        overviewContainer.innerHTML = '';
        overviewCards.forEach((card, index) => {
            const div = document.createElement('div');
            div.className = 'card-item';
            div.innerHTML = `
                <div class="form-group">
                    <label>Icon Class (Font Awesome)</label>
                    <input type="text" class="form-control overview-icon" value="${card.icon || ''}" data-index="${index}" placeholder="fas fa-icon-name">
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" class="form-control overview-title" value="${card.title || ''}" data-index="${index}">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control overview-description" rows="3" data-index="${index}">${card.description || ''}</textarea>
                </div>
                <button type="button" class="btn btn-sm btn-danger remove-btn remove-overview">Remove Card</button>
            `;
            overviewContainer.appendChild(div);
        });
        overviewInput.value = JSON.stringify(overviewCards);
    }

    document.getElementById('addOverviewCard').addEventListener('click', function() {
        overviewCards.push({icon: "", title: "", description: ""});
        renderOverviewCards();
    });

    overviewContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-overview')) {
            const index = e.target.closest('.card-item').querySelector('.overview-icon').dataset.index;
            overviewCards.splice(index, 1);
            renderOverviewCards();
        }
    });

    overviewContainer.addEventListener('input', function(e) {
        const index = e.target.dataset.index;
        if (e.target.classList.contains('overview-icon')) {
            overviewCards[index].icon = e.target.value;
        } else if (e.target.classList.contains('overview-title')) {
            overviewCards[index].title = e.target.value;
        } else if (e.target.classList.contains('overview-description')) {
            overviewCards[index].description = e.target.value;
        }
        overviewInput.value = JSON.stringify(overviewCards);
    });

    // Services Cards Management (similar pattern)
    const servicesContainer = document.getElementById('servicesCardsContainer');
    const servicesInput = document.getElementById('id_services_cards');

    function renderServicesCards() {
        servicesContainer.innerHTML = '';
        servicesCards.forEach((card, index) => {
            const div = document.createElement('div');
            div.className = 'card-item';
            div.innerHTML = `
                <div class="form-group">
                    <label>Icon Class</label>
                    <input type="text" class="form-control services-icon" value="${card.icon || ''}" data-index="${index}">
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" class="form-control services-title" value="${card.title || ''}" data-index="${index}">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control services-description" rows="2" data-index="${index}">${card.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Items (one per line)</label>
                    <textarea class="form-control services-items" rows="3" data-index="${index}">${Array.isArray(card.items) ? card.items.join('\n') : ''}</textarea>
                </div>
                <button type="button" class="btn btn-sm btn-danger remove-btn remove-services">Remove Card</button>
            `;
            servicesContainer.appendChild(div);
        });
        servicesInput.value = JSON.stringify(servicesCards);
    }

    document.getElementById('addServicesCard').addEventListener('click', function() {
        servicesCards.push({icon: "", title: "", description: "", items: []});
        renderServicesCards();
    });

    servicesContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-services')) {
            const index = e.target.closest('.card-item').querySelector('.services-icon').dataset.index;
            servicesCards.splice(index, 1);
            renderServicesCards();
        }
    });

    servicesContainer.addEventListener('input', function(e) {
        const index = e.target.dataset.index;
        if (e.target.classList.contains('services-icon')) {
            servicesCards[index].icon = e.target.value;
        } else if (e.target.classList.contains('services-title')) {
            servicesCards[index].title = e.target.value;
        } else if (e.target.classList.contains('services-description')) {
            servicesCards[index].description = e.target.value;
        } else if (e.target.classList.contains('services-items')) {
            servicesCards[index].items = e.target.value.split('\n').filter(item => item.trim());
        }
        servicesInput.value = JSON.stringify(servicesCards);
    });

    // Process Steps Management
    const processContainer = document.getElementById('processStepsContainer');
    const processInput = document.getElementById('id_process_steps');

    function renderProcessSteps() {
        processContainer.innerHTML = '';
        processSteps.forEach((step, index) => {
            const div = document.createElement('div');
            div.className = 'step-item';
            div.innerHTML = `
                <div class="form-group">
                    <label>Step Number</label>
                    <input type="text" class="form-control step-number" value="${step.number || ''}" data-index="${index}">
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" class="form-control step-title" value="${step.title || ''}" data-index="${index}">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control step-description" rows="2" data-index="${index}">${step.description || ''}</textarea>
                </div>
                <button type="button" class="btn btn-sm btn-danger remove-btn remove-step">Remove Step</button>
            `;
            processContainer.appendChild(div);
        });
        processInput.value = JSON.stringify(processSteps);
    }

    document.getElementById('addProcessStep').addEventListener('click', function() {
        processSteps.push({number: "", title: "", description: ""});
        renderProcessSteps();
    });

    processContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-step')) {
            const index = e.target.closest('.step-item').querySelector('.step-number').dataset.index;
            processSteps.splice(index, 1);
            renderProcessSteps();
        }
    });

    processContainer.addEventListener('input', function(e) {
        const index = e.target.dataset.index;
        if (e.target.classList.contains('step-number')) {
            processSteps[index].number = e.target.value;
        } else if (e.target.classList.contains('step-title')) {
            processSteps[index].title = e.target.value;
        } else if (e.target.classList.contains('step-description')) {
            processSteps[index].description = e.target.value;
        }
        processInput.value = JSON.stringify(processSteps);
    });

    // FAQ Management
    const faqContainer = document.getElementById('faqContainer');
    const faqInput = document.getElementById('id_faq_content');

    function renderFaqItems() {
        faqContainer.innerHTML = '';
        faqContent.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'faq-item';
            div.innerHTML = `
                <div class="form-group">
                    <label>Question</label>
                    <input type="text" class="form-control faq-question" value="${item.question || ''}" data-index="${index}">
                </div>
                <div class="form-group">
                    <label>Answer</label>
                    <textarea class="form-control faq-answer" rows="3" data-index="${index}">${item.answer || ''}</textarea>
                </div>
                <button type="button" class="btn btn-sm btn-danger remove-btn remove-faq">Remove FAQ</button>
            `;
            faqContainer.appendChild(div);
        });
        faqInput.value = JSON.stringify(faqContent);
    }

    document.getElementById('addFaq').addEventListener('click', function() {
        faqContent.push({question: "", answer: ""});
        renderFaqItems();
    });

    faqContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-faq')) {
            const index = e.target.closest('.faq-item').querySelector('.faq-question').dataset.index;
            faqContent.splice(index, 1);
            renderFaqItems();
        }
    });

    faqContainer.addEventListener('input', function(e) {
        const index = e.target.dataset.index;
        if (e.target.classList.contains('faq-question')) {
            faqContent[index].question = e.target.value;
        } else if (e.target.classList.contains('faq-answer')) {
            faqContent[index].answer = e.target.value;
        }
        faqInput.value = JSON.stringify(faqContent);
    });

    // Initial render
    renderOverviewCards();
    renderServicesCards();
    renderProcessSteps();
    renderFaqItems();
});
</script>
{% endblock %}