{% block admission-content %}
<div class="section-header">
    <div class="header-content">
        <div class="title-section">
            <h2 class="section-heading">Admission Applications</h2>
            <div class="divider"></div>
        </div>

        <!-- Admission Statistics Section -->
        <div class="admission-stats-section">
            <div class="admission-stats-container">
                <div class="admission-stats-group">
                    <h4>Student Types</h4>
                    <div class="stats-row">
                        <div class="admission-stat-box">
                            <div class="stat-icon" style="background-color: #4caf50;">
                                <i class='bx bx-user'></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">
                                    {% if request.user.is_superuser or request.user.user_type == 1 %}
                                        {{ current_grade12_count }}
                                    {% else %}
                                        {{ user_current_grade12_count }}
                                    {% endif %}
                                </span>
                                <span class="stat-label">Current G12</span>
                            </div>
                        </div>
                        <div class="admission-stat-box">
                            <div class="stat-icon" style="background-color: #2196f3;">
                                <i class='bx bx-user'></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">
                                    {% if request.user.is_superuser or request.user.user_type == 1 %}
                                        {{ shs_graduate_count }}
                                    {% else %}
                                        {{ user_shs_graduate_count }}
                                    {% endif %}
                                </span>
                                <span class="stat-label">SHS Graduates</span>
                            </div>
                        </div>
                        <div class="admission-stat-box">
                            <div class="stat-icon" style="background-color: #ff9800;">
                                <i class='bx bx-transfer'></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">
                                    {% if request.user.is_superuser or request.user.user_type == 1 %}
                                        {{ transferee_count }}
                                    {% else %}
                                        {{ user_transferee_count }}
                                    {% endif %}
                                </span>
                                <span class="stat-label">Transferees</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Requirement Status Statistics -->
                <div class="admission-stats-group">
                    <h4>Requirement Status</h4>
                    <div class="stats-row">
                        <div class="admission-stat-box">
                            <div class="stat-icon" style="background-color: #8bc34a;">
                                <i class='bx bx-check-circle'></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">
                                    {% if request.user.is_superuser or request.user.user_type == 1 %}
                                        {{ complete_requirements_count }}
                                    {% else %}
                                        {{ user_complete_requirements_count }}
                                    {% endif %}
                                </span>
                                <span class="stat-label">Complete</span>
                            </div>
                        </div>
                        <div class="admission-stat-box">
                            <div class="stat-icon" style="background-color: #f44336;">
                                <i class='bx bx-error-circle'></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">
                                    {% if request.user.is_superuser or request.user.user_type == 1 %}
                                        {{ incomplete_requirements_count }}
                                    {% else %}
                                        {{ user_incomplete_requirements_count }}
                                    {% endif %}
                                </span>
                                <span class="stat-label">Incomplete</span>
                            </div>
                        </div>
                        <div class="admission-stat-box total">
                            <div class="stat-icon" style="background-color: #607d8b;">
                                <i class='bx bx-stats'></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-number">
                                    {% if request.user.is_superuser or request.user.user_type == 1 %}
                                        {{ total_admissions }}
                                    {% else %}
                                        {{ user_total_admissions }}
                                    {% endif %}
                                </span>
                                <span class="stat-label">Total Applications</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="search-box">
                <i class='bx bx-search'></i>
                <input type="text" id="admission-search" placeholder="Search applications..." class="search-input">
            </div>
            <div class="type-sort">
                <select id="type-sort" class="styled-select">
                    <option value="">All Types</option>
                    <option value="current_grade12">Current Grade 12</option>
                    <option value="shs_graduate">SHS Graduate</option>
                    <option value="transferee">Transferee</option>
                </select>
            </div>
            <a href="{% url 'admission_create' %}" class="primary-btn"><i class='bx bx-plus'></i> Add New Application</a>
            {% if request.user.is_superuser or request.user.user_type == 1 or request.user.user_type == 12 %}
                <button class="primary-btn" id="export-admission-btn"><i class='bx bx-export'></i> Export Data </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Loading overlay for table -->
<div id="table-loading" class="table-loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <i class='bx bx-loader-alt bx-spin'></i>
        <span></span>
    </div>
</div>

<table class="data-table" id="admissions-table">
    <thead>
        <tr>
            <th data-sort="control_no">Control No. <i class='bx bx-sort'></i></th>
            <th data-sort="student">Student Name <i class='bx bx-sort'></i></th>
            <th data-sort="student_type">Student Type <i class='bx bx-sort'></i></th>
            <th data-sort="course">Course <i class='bx bx-sort'></i></th>
            <th data-sort="status">Status <i class='bx bx-sort'></i></th>
            <th>Remarks</th>
            <th data-sort="created_at">Date Submitted <i class='bx bx-sort'></i></th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for admission in admissions %}
    <tr data-student-type="{{ admission.student_type }}"
        data-created-at="{{ admission.created_at|date:'c' }}"
        data-status="{{ admission.status }}">
        <td data-sort-value="{{ admission.control_no }}">{{ admission.control_no }}</td>
        <td data-sort-value="{% if admission.user %}{{ admission.user.last_name|lower }}{% endif %}">
                {% if admission.user %}
                    {{ admission.user.last_name }}, {{ admission.user.first_name }}
                {% else %}
                    (No user associated)
                {% endif %}
            </td>
        <td data-sort-value="{{ admission.get_student_type_display }}">{{ admission.get_student_type_display }}</td>
        <td data-sort-value="{{ admission.course }}">{{ admission.course }}</td>
        <td data-sort-value="{{ admission.status }}">
            <span class="status-badge {% if admission.status == 'done' %}done
                                      {% elif admission.status == 'incomplete' %}incomplete
                                      {% else %}pending{% endif %}">
                {{ admission.get_status_display }}
            </span>
        </td>
        <td class="remarks-cell"
            data-missing="{% if admission.status == 'incomplete' %}true{% else %}false{% endif %}"
            data-complete="{% if admission.status == 'complete' %}true{% else %}false{% endif %}"
            data-full-remarks="{{ admission.remarks|default:'-' }}">
            {% if admission.remarks %}
                {% with remarks=admission.remarks|striptags %}
                    {% if "To Follow Requirements:" in remarks %}
                        {{ remarks|truncatechars:100 }}
                    {% else %}
                        {{ remarks }}
                    {% endif %}
                {% endwith %}
            {% else %}
                -
            {% endif %}
        </td>
        <td data-sort-value="{{ admission.created_at|date:'U' }}">
            {{ admission.created_at|date:"M d, Y" }}
        </td>
            <td class="actions">
            {% if request.user.is_superuser or request.user.user_type == 1 or request.user.user_type == 12 %}
                {% if admission.status != 'done' %}
                    <button class="btn-icon approve-admission" title="Approve" onclick="openApproveAdmissionModal({{ admission.id }})"><i class='bx bx-check'></i></button>
                {% endif %}
            {% endif %}

            <button class="btn-icon view-admission" title="View" data-admission-id="{{ admission.id }}"><i class="ri-eye-fill"></i></button>

            {% if not request.user.is_student or admission.status != 'done' %}
                <button class="btn-icon edit-admission" title="Edit Status" onclick="openAdmissionEditModal({{ admission.id }})"><i class='bx bx-edit'></i></button>
            {% endif %}

            {% if not request.user.is_student or admission.status != 'done' %}
                <button class="btn-icon archive-admission" onclick="openArchiveAdmissionModal('{{ admission.id }}')" title="Archive"><i class='bx bxs-archive'></i></button>
            {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination Controls -->
{% if admissions %}
<div class="pagination-container">
    <div class="pagination-info">
        Showing {{ admissions.start_index }} to {{ admissions.end_index }} of {{ admissions.paginator.count }} entries
    </div>
    <div class="pagination-controls">
        {% if admissions.has_previous %}
            <a href="?admission_page=1#admission-applications" class="pagination-btn first-page" title="First Page">
                <i class='bx bx-chevrons-left'></i>
            </a>
            <a href="?admission_page={{ admissions.previous_page_number }}#admission-applications" class="pagination-btn prev-page" title="Previous Page">
                <i class='bx bx-chevron-left'></i>
            </a>
        {% else %}
            <span class="pagination-btn first-page disabled" title="First Page">
                <i class='bx bx-chevrons-left'></i>
            </span>
            <span class="pagination-btn prev-page disabled" title="Previous Page">
                <i class='bx bx-chevron-left'></i>
            </span>
        {% endif %}

        <div class="page-numbers">
            {% for num in admissions.paginator.page_range %}
                {% if admissions.number == num %}
                    <span class="pagination-btn current-page active">{{ num }}</span>
                {% elif num > admissions.number|add:'-3' and num < admissions.number|add:'3' %}
                    <a href="?admission_page={{ num }}#admission-applications" class="pagination-btn page-number">{{ num }}</a>
                {% endif %}
            {% endfor %}
        </div>

        {% if admissions.has_next %}
            <a href="?admission_page={{ admissions.next_page_number }}#admission-applications" class="pagination-btn next-page" title="Next Page">
                <i class='bx bx-chevron-right'></i>
            </a>
            <a href="?admission_page={{ admissions.paginator.num_pages }}#admission-applications" class="pagination-btn last-page" title="Last Page">
                <i class='bx bx-chevrons-right'></i>
            </a>
        {% else %}
            <span class="pagination-btn next-page disabled" title="Next Page">
                <i class='bx bx-chevron-right'></i>
            </span>
            <span class="pagination-btn last-page disabled" title="Last Page">
                <i class='bx bx-chevrons-right'></i>
            </span>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock admission-content %}